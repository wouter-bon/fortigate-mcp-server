{
  "name": "FortiGate MCP Chat Assistant v2",
  "nodes": [
    {
      "parameters": {
        "public": true,
        "initialMessages": "Welcome to FortiGate MCP Assistant!\n\nI can help you manage your FortiGate firewalls and FortiManager.\n\n**Available Options:**\n\nüî∑ **FortiGate API** (Security Fabric Root)\n- List devices\n- View firewall policies\n- Check interfaces and routes\n- View certificates\n- Security Fabric status\n\nüî∂ **FortiManager API**\n- List managed devices across ADOMs\n- View policy packages\n- Get certificates from all devices\n- Check device status\n\n**Example commands:**\n- \"List all FortiGate devices\"\n- \"Show firewall policies\"\n- \"Get security fabric status\"\n- \"List FortiManager devices in BACKUP ADOM\"\n- \"Get all certificates from FortiManager\"\n\nWhat would you like to do?",
        "options": {
          "responseMode": "lastNode"
        }
      },
      "id": "chat-trigger",
      "name": "Chat Trigger",
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [0, 300],
      "webhookId": "fortigate-mcp-chat-v2"
    },
    {
      "parameters": {
        "jsCode": "// Parse user input and call MCP server\nconst userInput = $input.first().json.chatInput.toLowerCase();\n\nlet tool = null;\nlet args = {};\n\n// FortiGate tools\nif (userInput.includes('list') && userInput.includes('device')) {\n  tool = 'list_devices';\n  args = {};\n} else if (userInput.includes('firewall') && userInput.includes('polic')) {\n  tool = 'list_firewall_policies';\n  args = { device_id: 'default' };\n} else if (userInput.includes('interface')) {\n  tool = 'list_interfaces';\n  args = { device_id: 'default' };\n} else if (userInput.includes('route') || userInput.includes('routing')) {\n  tool = 'get_routing_table';\n  args = { device_id: 'default' };\n} else if (userInput.includes('fabric') && userInput.includes('status')) {\n  tool = 'get_security_fabric_status';\n  args = { device_id: 'default' };\n} else if (userInput.includes('fabric') && userInput.includes('config')) {\n  tool = 'get_security_fabric_config';\n  args = { device_id: 'default' };\n} else if (userInput.includes('ha') && userInput.includes('status')) {\n  tool = 'get_ha_status';\n  args = { device_id: 'default' };\n} else if (userInput.includes('certificate') && !userInput.includes('fortimanager') && !userInput.includes('fmg')) {\n  tool = 'list_local_certificates';\n  args = { device_id: 'default' };\n} else if (userInput.includes('address') && userInput.includes('object')) {\n  tool = 'list_address_objects';\n  args = { device_id: 'default' };\n} else if (userInput.includes('service') && userInput.includes('object')) {\n  tool = 'list_service_objects';\n  args = { device_id: 'default' };\n} else if (userInput.includes('vip') || userInput.includes('virtual ip')) {\n  tool = 'list_virtual_ips';\n  args = { device_id: 'default' };\n} else if (userInput.includes('device') && userInput.includes('status')) {\n  tool = 'get_device_status';\n  args = { device_id: 'default' };\n}\n// FortiManager tools\nelse if (userInput.includes('fortimanager') || userInput.includes('fmg')) {\n  if (userInput.includes('device') && userInput.includes('status')) {\n    tool = 'fmg_get_all_devices_status';\n    args = { manager_id: 'fmg1' };\n    if (userInput.includes('backup')) args.adom = 'BACKUP';\n    else if (userInput.includes('root')) args.adom = 'root';\n  } else if (userInput.includes('device')) {\n    tool = 'fmg_get_devices';\n    args = { manager_id: 'fmg1' };\n    if (userInput.includes('backup')) args.adom = 'BACKUP';\n    else if (userInput.includes('root')) args.adom = 'root';\n  } else if (userInput.includes('certificate') || userInput.includes('cert')) {\n    tool = 'fmg_get_all_certificates';\n    args = { manager_id: 'fmg1', adoms: 'BACKUP,root' };\n    if (userInput.includes('letsencrypt') || userInput.includes('le ')) {\n      args.filter_letsencrypt = true;\n    }\n  } else if (userInput.includes('adom')) {\n    tool = 'fmg_get_adoms';\n    args = { manager_id: 'fmg1' };\n  } else if (userInput.includes('policy') && userInput.includes('package')) {\n    tool = 'fmg_get_policy_packages';\n    args = { manager_id: 'fmg1' };\n    if (userInput.includes('backup')) args.adom = 'BACKUP';\n  } else if (userInput.includes('status')) {\n    tool = 'fmg_get_system_status';\n    args = { manager_id: 'fmg1' };\n  } else {\n    tool = 'fmg_get_devices';\n    args = { manager_id: 'fmg1', adom: 'BACKUP' };\n  }\n}\n// Help\nelse if (userInput.includes('help') || userInput.includes('tool') || userInput.includes('command')) {\n  return {\n    output: '**Available Commands:**\\n\\nüî∑ **FortiGate:**\\n- \"List devices\" - Show registered devices\\n- \"Show firewall policies\" - Display firewall rules\\n- \"Get interfaces\" - List network interfaces\\n- \"Get routing table\" - Show routes\\n- \"Security fabric status\" - View fabric topology\\n- \"HA status\" - High availability status\\n- \"List certificates\" - Local certificates\\n\\nüî∂ **FortiManager:**\\n- \"FMG devices\" - List managed devices\\n- \"FMG devices in BACKUP\" - Devices in BACKUP ADOM\\n- \"FMG certificates\" - All certificates\\n- \"FMG ADOMs\" - List administrative domains\\n- \"FMG policy packages\" - Policy packages\\n\\nJust type your command!'\n  };\n}\n\nif (!tool) {\n  return {\n    output: `I didn't understand: \"${$input.first().json.chatInput}\"\\n\\nTry: \"List devices\", \"Show firewall policies\", \"FMG devices\", or \"Help\"`\n  };\n}\n\n// Call MCP server\nconst MCP_URL = 'http://10.129.255.6:8814/fortigate-mcp';\n\ntry {\n  // Initialize session\n  const initResponse = await fetch(MCP_URL, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json, text/event-stream'\n    },\n    body: JSON.stringify({\n      jsonrpc: '2.0',\n      id: 1,\n      method: 'initialize',\n      params: {\n        protocolVersion: '2024-11-05',\n        capabilities: {},\n        clientInfo: { name: 'n8n', version: '1.0' }\n      }\n    })\n  });\n  \n  const initText = await initResponse.text();\n  // Parse SSE response\n  const initData = initText.split('\\n').find(l => l.startsWith('data: '));\n  if (!initData) throw new Error('No init response');\n  const initJson = JSON.parse(initData.replace('data: ', ''));\n  \n  // Get session ID from response headers or generate one\n  const sessionId = initResponse.headers.get('mcp-session-id') || 'n8n-session-' + Date.now();\n  \n  // Call the tool\n  const toolResponse = await fetch(MCP_URL, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json, text/event-stream',\n      'mcp-session-id': sessionId\n    },\n    body: JSON.stringify({\n      jsonrpc: '2.0',\n      id: 2,\n      method: 'tools/call',\n      params: {\n        name: tool,\n        arguments: args\n      }\n    })\n  });\n  \n  const toolText = await toolResponse.text();\n  // Parse SSE response\n  const toolData = toolText.split('\\n').find(l => l.startsWith('data: '));\n  if (!toolData) throw new Error('No tool response');\n  const toolJson = JSON.parse(toolData.replace('data: ', ''));\n  \n  // Format output\n  let output = `**Tool:** \\`${tool}\\`\\n\\n`;\n  \n  if (toolJson.error) {\n    output += `‚ùå Error: ${toolJson.error.message}`;\n  } else if (toolJson.result?.content) {\n    const content = toolJson.result.content;\n    if (Array.isArray(content)) {\n      output += content.map(c => c.text || JSON.stringify(c)).join('\\n');\n    } else {\n      output += JSON.stringify(content, null, 2);\n    }\n  } else {\n    output += JSON.stringify(toolJson.result || toolJson, null, 2);\n  }\n  \n  // Truncate if too long\n  if (output.length > 4000) {\n    output = output.substring(0, 4000) + '\\n\\n... (truncated)';\n  }\n  \n  return { output };\n  \n} catch (error) {\n  return {\n    output: `‚ùå Error connecting to MCP server: ${error.message}\\n\\nPlease ensure the FortiGate MCP server is running at ${MCP_URL}`\n  };\n}"
      },
      "id": "mcp-handler",
      "name": "MCP Handler",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 300]
    }
  ],
  "connections": {
    "Chat Trigger": {
      "main": [
        [
          {
            "node": "MCP Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
